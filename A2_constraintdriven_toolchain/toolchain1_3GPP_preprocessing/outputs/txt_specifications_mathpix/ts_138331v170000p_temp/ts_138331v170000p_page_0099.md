<!-- Page 99 of ts_138331v170000p -->

3GPP TS 38.331 version 17.0.0 Release 17
98
ETSI TS 138331 V17.0.0 (2022-05)

3> derive the \( K_{R R C e n c} \) and \( K_{U P e n c} \) keys as specified in TS 33.401 [30] for EN-DC, or TS 33.501 [11] for NGEN-DC;

3> derive the \( \mathrm{K}_{\text {RRGint }} \) and \( \mathrm{K}_{\text {UPmt }} \) keys as specified in TS 33.401 [30] for EN-DC or TS 33.501 [11] for NGENDC.

1> else if this procedure was initiated due to reception of the masterKeyUpdate:
\( 2> \) if the nas-Container is included in the received masterKeyUpdate:
3> forward the nas-Container to the upper layers;
\( 2> \) if the keySetChangeIndicator is set to true:
3> derive or update the \( \mathrm{K}_{\mathrm{gNB}} \) key based on the \( \mathrm{K}_{\mathrm{AMF}} \) key, as specified in TS 33.501 [11];
\( 2> \) else:
3> derive or update the \( \mathrm{K}_{\mathrm{gNB}} \) key based on the current \( \mathrm{K}_{\mathrm{gNB}} \) key or the NH , using the nextHopChainingCount value indicated in the received masterKeyUpdate, as specified in TS 33.501 [11];
\( 2> \) store the nextHopChainingCount value;
\( 2> \) derive the keys associated with the \( \mathrm{K}_{\mathrm{gNB}} \) key as follows:
\( 3> \) if the securityAlgorithmConfig is included in SecurityConfig:
\( 4> \) derive the \( \mathrm{K}_{\text {RRCenc }} \) and \( \mathrm{K}_{\text {UPenc }} \) keys associated with the cipheringAlgorithm indicated in the securityAlgorithmConfig, as specified in TS 33.501 [11];

4> derive the \( \mathrm{K}_{\mathrm{RRC} \text { int }} \) and \( \mathrm{K}_{\text {UPnt }} \) keys associated with the integrityProtAlgorithm indicated in the securityAlgorithmConfig, as specified in TS 33.501 [11];
\( 3> \) else:
4> derive the \( \mathrm{K}_{\mathrm{RRCenc}} \) and \( \mathrm{K}_{\mathrm{UPenc}} \) keys associated with the current cipheringAlgorithm, as specified in TS \( 33.501[11] ; \)

4> derive the \( \mathrm{K}_{\mathrm{RRC} \text { int }} \) and \( \mathrm{K}_{\text {UPnt }} \) keys associated with the current integrityProtAlgorithm, as specified in TS 33.501 [11].

NOTE 1: Ciphering and integrity protection are optional to configure for the DRBs.
\( 1> \) else if this procedure was initiated due to reception of the \( s k \)-Counter (UE is in NE-DC, or NR-DC, or is configured with SN terminated bearer(s)):
\( 2> \) derive or update the secondary key ( \( \mathrm{S}-\mathrm{K}_{\mathrm{gNB}} \) or S-KeNB) based on the KgNB key and using the received \( s k \) Counter value, as specified in TS 33.501 [11];
\( 2> \) derive the \( K_{\text {RRCenc }} \) key and the \( K_{\text {UPenc }} \) key as specified in TS 33.501 [11] using the ciphering algorithms indicated in the RadioBearerConfig associated with the secondary key ( \( \mathrm{S}-\mathrm{K}_{\mathrm{gNB}} \) or S-KeNB) as indicated by keyToUse;
\( 2> \) derive the \( K_{\text {RRCint }} \) key and the \( K_{\text {UPint }} \) key as specified in TS 33.501 [11] using the integrity protection algorithms indicated in the RadioBearerConfig associated with the secondary key ( \( \mathrm{S}-\mathrm{K}_{\mathrm{gNB}} \) or S-KeNB) as indicated by keyToUse;

NOTE 2: If the UE has no radio bearer configured with keyToUse set to secondary and receives the sk-Counter without any RadioBearerConfig with keyToUse set to secondary, the UE does not consider it as an invalid reconfiguration.

ETSI