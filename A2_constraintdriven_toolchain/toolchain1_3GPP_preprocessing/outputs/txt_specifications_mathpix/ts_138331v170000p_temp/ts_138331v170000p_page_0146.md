<!-- Page 146 of ts_138331v170000p -->

3GPP TS 38.331 version 17.0.0 Release 17
145
ETSI TS 138331 V17.0.0 (2022-05)

1> else:
\( 2> \) start timer T319;
\( 2> \) instruct the MAC entity to consider the cg-SDT-TimeAlignmentTimer as expired, if it is running;
\( 1> \) set the variable pendingRNA-Update to false;
\( 1> \) release successHO-Config from the UE Inactive AS context, if stored;
\( 1> \) initiate transmission of the RRCResumeRequest message or RRCResumeRequest 1 in accordance with 5.3.13.3.
5.3.13.3 Actions related to transmission of RRCResumeRequest or RRCResumeRequest1 message

The UE shall set the contents of RRCResumeRequest or RRCResumeRequest I message as follows:
\( 1> \) if field \( u s e F \) UllResumelD is signalled in SIBI:
\( 2> \) select RRCResumeRequestl as the message to use;
\( 2> \) set the resumeldentity to the stored fullI-RNTI value;
1> else:
\( 2> \) select RRCResumeRequest as the message to use;
\( 2> \) set the resumeldentity to the stored shortl-RNTI value;
\( 1> \) restore the RRC configuration, RoHC state, the stored QoS flow to DRB mapping rules and the \( K_{g N B} \) and \( K_{R R C \text { int }} \) keys from the stored UE Inactive AS context except for the following:
- masterCellGroup;
- mrdc-SecondaryCellGroup, if stored; and
- pdcp-Config;
\( 1> \) set the resumeMAC-I to the 16 least significant bits of the MAC-I calculated:
\( 2> \) over the ASN 1 encoded as per clause 8 (i.e., a multiple of 8 bits) VarResumeMAC-Input;
\( 2> \) with the \( K_{R R C n t} \) key in the UE [nactive AS Context and the previously configured integrity protection algorithm; and
\( 2> \) with all input bits for COUNT, BEARER and DIRECTION set to binary ones;
\( 1> \) derive the \( \mathrm{K}_{\mathrm{gNB}} \) key based on the current \( \mathrm{K}_{\mathrm{gNB}} \) key or the NH , using the nextHopChainingCount value received in the previous RRCRelease message and stored in the UE Inactive AS Context, as specified in TS 33.501[11];
\( 1> \) derive the \( K_{R R C e n c} \) key, the \( K_{R R C i n t} \) key, the \( K_{\text {UPint }} \) key and the \( K_{\text {UPenc }} \) key;
\( 1> \) configure lower layers to apply integrity protection for all radio bearers except SRB0 and MRBs using the configured algorithm and the \( K_{R R C \text { mt }} \) key and \( K_{\text {UPmn }} \) key derived in this clause immediately, i.e., integrity protection shall be applied to all subsequent messages received and sent by the UE;

NOTE 1: Only DRBs with previously configured UP integrity protection shall resume integrity protection.
\( 1> \) configure lower layers to apply ciphering for all radio bearers except SRB0 and MRBs and to apply the configured ciphering algorithm, the \( K_{R R C e n c} \) key and the \( K_{\text {UPENC }} \) key derived in this clause, ie the ciphering configuration shall be applied to all subsequent messages received and sent by the UE;
\( 1> \) re-establish PDCP entities for SRB1;
\( 1> \) resume SRB1;
\( 1> \) if the resume procedure is initiated for SDT:

ETSI