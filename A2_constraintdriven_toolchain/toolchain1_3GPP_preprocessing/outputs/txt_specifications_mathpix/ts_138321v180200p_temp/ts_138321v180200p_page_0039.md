<!-- Page 39 of ts_138321v180200p -->

3GPP TS 38.321 version 18.2.0 Release 18
38
ETSI TS 138321 V18.2.0 (2024-08)

\( 2> \) select a Random Access Preamble randomly with equal probability from the 2 -step RA type Random Access Preambles associated with the selected SSB and the selected Random Access Preambles group;
\( 2> \) set the PREAMBLE_INDEX to the selected Random Access Preamble.
\( 1> \) determine the next available PRACH occasion from the PRACH occasions corresponding to the selected SSB permitted by the restrictions given by the msgA-SSB-SharedRO-MaskIndex if configured, or ra-ssbOccasionMaskIndex if configured, or ssb-SharedRO-MaskIndex if configured (the MAC entity shall select a PRACH occasion randomly with equal probability among the consecutive PRACH occasions allocated for 2-step RA type according to clause 8.1 of TS 38.213 [6] regardless the FR2 UL gap, corresponding to the selected SSB; the MAC entity may take into account the possible occurrence of measurement gaps and MUSIM gaps when determining the next available PRACH occasion corresponding to the selected SSB);
\( 1> \) if the Random Access Preamble was not selected by the MAC entity among the contention-based Random Access Preamble(s):
\( 2> \) select a PUSCH occasion from the PUSCH occasions configured in msgA-CFRA-PUSCH corresponding to the PRACH slot of the selected PRACH occasion, according to msgA-PUSCH-Resource-Index corresponding to the selected SSB;
\( 2> \) determine the UL grant and the associated HARQ information for the MSGA payload in the selected PUSCH occasion;
\( 2> \) deliver the UL grant and the associated HARQ information to the HARQ entity.
\( 1> \) else:
\( 2> \) select a PUSCH occasion corresponding to the selected preamble and PRACH occasion according to clause 8.1A of TS 38.213 [6];
\( 2> \) determine the UL grant for the MSGA payload according to the PUSCH configuration associated with the selected Random Access Preambles group and determine the associated HARQ information;
\( 2> \) if the selected preamble and PRACH occasion is mapped to a valid PUSCH occasion as specified in clause 8.1A of TS 38.213 [6]:
\( 3> \) deliver the UL grant and the associated HARQ information to the HARQ entity.
1> perform the MSGA transmission procedure (see clause 5.1.3a).
NOTE 1: To determine if there is an SSB with SS-RSRP above msgA-RSRP-ThresholdSSB, the UE uses the latest unfiltered \( L l-R S R P \) measurement.

NOTE 2: If an (e)RedCap UE in RRC_IDLE or RRC_INACTIVE mode is configured with a BWP indicated by initial DownlinkB WP-RedCap which is not associated with any SSB, SS-RSRP measurement is performed based on the SSB associated with the BWP indicated by mittalDownlinkBWP. If an (e)RedCap UE in RRC_INACTIVE mode is configured with SDT and with a BWP indicated by mitial DownlinkBWPRedCap which is associated with NCD-SSB, SS-RSRP measurement can also be performed based on this NCD-SSB during SDT.

NOTE 3: If an (e)RedCap UE in RRC_IDLE or RRC_INACTIVE mode is configured with a BWP indicated by initialDownlinkBWP-RedCap which is not associated with any SSB for RACH, it is up to the UE implementation to perform a new RSRP measurements before Msg1/MsgA retransmission.
5.1.3 Random Access Preamble transmission

The MAC entity shall, for each Random Access Preamble:
1> if PREAMBLE_TRANSMISSION_COUNTER is greater than one; and
\( 1> \) if the notification of suspending power ramping counter has not been received from lower layers; and
\( 1> \) if LBT failure indication was not received from lower layers for the last Random Access Preamble transmission; and

ETSI