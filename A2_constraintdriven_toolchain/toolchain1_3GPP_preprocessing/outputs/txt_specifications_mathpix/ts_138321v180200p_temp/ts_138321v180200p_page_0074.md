<!-- Page 74 of ts_138321v180200p -->

3GPP TS 38.321 version 18.2.0 Release 18
73
ETSI TS 138321 V18.2.0 (2024-08)

\( 2> \) set \( B j \) to the bucket size.
NOTE: The exact moment(s) when the UE updates Bj between LCP procedures is up to UE implementation, as long as Bj is up to date at the time when a grant is processed by LCP.
5.4.3.1.2 Selection of logical channels

The MAC entity shall, when a new transmission is performed:
\( 1> \) select the logical channels for each UL grant that satisfy all the following conditions:
\( 2> \) the set of allowed Subcarrier Spacing index values in allowedSCS-List, if configured, includes the Subcarrier Spacing index associated to the UL grant; and
\( 2> \) maxPUSCH-Duration, if configured, is larger than or equal to the PUSCH transmission duration associated to the UL grant; and
\( 2> \) configuredGrantTypelAllowed, if configured, is set to true in case the UL grant is a Configured Grant Type 1; and
\( 2> \) allowedServingCells, if configured, includes the Cell information associated to the UL grant. Does not apply to logical channels associated with a DRB configured with PDCP duplication within the same MAC entity (i.e. CA duplication) when CA duplication is deactivated for this DRB in this MAC entity; and
\( 2> \) allowedCG-List, if configured, includes the configured grant index associated to the UL grant; and
2> allowedPHY-PriorityIndex, if configured, includes the priority index (as specified in clause 9 of TS 38.213 [6]) associated to the dynamic UL grant; and
\( 2> \) allowedHARQ-mode, if configured, includes the allowed UL HARQ mode for the HARQ process associated to the UL grant.

NOTE: The Subcarrier Spacing index, PUSCH transmission duration, Cell information, and priority index are included in Uplink transmission information received from lower layers for the corresponding scheduled uplink transmission.
5.4.3.1.3 Allocation of resources

Before the successful completion of the Random Access procedure initiated for DAPS handover, the target MAC entity shall not select the logical channel(s) corresponding to non-DAPS DRB(s) for the uplink grant received in a Random Access Response or the uplink grant for the transmission of the MSGA payload. The source MAC entity shall select only the logical channel(s) corresponding to DAPS DRB(s) during DAPS handover.

The MAC entity shall, when a new transmission is performed:
\( 1> \) allocate resources to the logical channels as follows:
\( 2> \) logical channels selected in clause 5.4.3.1.2 for the UL grant with \( B j>0 \) are allocated resources in a decreasing priority order. If the PBR of a logical channel is set to infinity, the MAC entity shall allocate resources for all the data that is available for transmission on the logical channel before meeting the PBR of the lower priority logical channel(s);
\( 2> \) decrement \( B j \) by the total size of MAC SDUs served to logical channel \( j \) above;
\( 2> \) if any resources remain, all the logical channels selected in clause 5.4.3.1.2 are served in a strict decreasing priority order (regardless of the value of \( B j \) ) until either the data for that logical channel or the UL grant is exhausted, whichever comes first. Logical channels configured with equal priority should be served equally.

NOTE 1: The value of \( B j \) can be negative.
If the MAC entity is requested to simultaneously transmit multiple MAC PDUs, or if the MAC entity receives the multiple UL grants within one or more coinciding PDCCH occasions (i.e on different Serving Cells), it is up to UE implementation in which order the grants are processed.

The UE shall also follow the rules below during the scheduling procedures above:

ETSI