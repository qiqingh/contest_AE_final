<!-- Page 42 of ts_138321v180200p -->

3GPP TS 38.321 version 18.2.0 Release 18
41
ETSI TS 138321 V18.2.0 (2024-08)

\( 2> \) instruct the physical layer to cancel the transmission of the MSGA payload on the associated PUSCH resource;
\( 2> \) if Ibt-FailureRecoveryConfig is configured:
3> perform the Random Access Resource selection procedure for 2-step RA type (see clause 5.1.2a).
\( 2> \) else:
3> increment PREAMBLE_TRANSMISSION_COUNTER by 1;
3> if PREAMBLE_TRANSMISSION_COUNTER \( = \) preambleTransMax +1 :
\( 4> \) indicate a Random Access problem to upper layers;
4> if this Random Access procedure was triggered for SI request:
\( 5> \) consider this Random Access procedure unsuccessfully completed.
3> if the Random Access procedure is not completed:
\( 4> \) if msgA-TransMax is applied (see clause 5.1.1a) and PREAMBLE_TRANSMISSION_COUNTER \( = \) msgA-TransMax +1 :
\( 5> \) set the RA_TYPE to 4-stepRA;
\( 5> \) perform initialization of variables specific to Random Access type as specified in clause 5.1.1a;
\( 5> \) if the Msg3 buffer is empty:
6> obtain the MAC PDU to transmit from the MSGA buffer and store it in the Msg3 buffer;
\( 5> \) flush HARQ buffer used for the transmission of MAC PDU in the MSGA buffer;
\( 5> \) discard explicitly signalled contention-free 2 -step RA type Random Access Resources, if any;
\( 5> \) perform the Random Access Resource selection procedure as specified in clause 5.1.2.
4> else:
\( 5> \) perform the Random Access Resource selection procedure for 2-step RA type (see clause 5.1.2a).
NOTE: The MSGA transmission includes the transmission of the PRACH Preamble as well as the contents of the MSGA buffer in the PUSCH resource corresponding to the selected PRACH occasion and PREAMBLE_INDEX (see TS 38.213 [6])

The MSGB-RNTI associated with the PRACH occasion in which the Random Access Preamble is transmitted, is computed as:
\[
\text { MSGB-RNTI }=1+\text { s_id }+14 \times \text { t_id }+14 \times 80 \times \text { f_id }+14 \times 80 \times 8 \times \text { ul_carrier_id }+14 \times 80 \times 8 \times 2
\]
where s_id is the index of the first OFDM symbol of the PRACH occasion ( \( 0 \leq s \_ \)id \( <14 \) ), t_id is the index of the first slot of the PRACH occasion in a system frame ( \( 0 \leq \mathrm{t} \_\mathrm{id}<80 \) ), where the subcarrier spacing to determine t id is based on the value of \( \mu \) specified in clause 5.3.2 in TS 38.211 [8] for \( \mu=\{0,1,2,3\} \), and for \( \mu=\{5,6\}, \mathrm{t} \) id is the index of the 120 kHz slot in a system frame that contains the PRACH occasion ( \( 0 \leq \mathrm{t} \_\mathrm{id}<80 \) ), f_id is the index of the PRACH occasion in the frequency domain ( \( 0 \leq \mathrm{f} \) id \( <8 \) ), and ul_carrier_id is the UL carrier used for Random Access Preamble transmission ( 0 for NUL carrier, and 1 for SUL carrier)- The RA-RNTI is calculated as specified in clause 5.1.3.
5.1.4 Random Access Response reception

Once the Random Access Preamble is transmitted and regardless of the possible occurrence of a measurement gap, the MAC entity shall:
\( 1> \) if the contention-free Random Access Preamble for beam failure recovery request was transmitted by the MAC entity:

ETSI