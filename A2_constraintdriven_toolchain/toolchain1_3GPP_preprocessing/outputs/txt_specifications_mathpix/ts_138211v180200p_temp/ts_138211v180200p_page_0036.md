<!-- Page 36 of ts_138211v180200p -->

3GPP TS 38.211 version 18.2.0 Release 18
35
ETSI TS 138211 V18.2.0 (2024-05)

shall be mapped onto the layers \( x(i)=\left[x^{(0)}(i) \quad \ldots \quad x^{(v-1)}(i)\right]^{\mathrm{T}}, i=0,1, \ldots, M_{\text {symb }}^{\text {layer }}-1 \) where \( v \) is the number of layers and \( M_{\text {symb }}^{\text {layer }} \) is the number of modulation symbols per layer.
6.3.1.4 Transform precoding

If transform precoding is not enabled according to 6.13 of \( [6, \operatorname{TS38.214}], y^{(\lambda)}(i)=x^{(\lambda)}(i) \) for each layer \( \lambda=0,1, \ldots, v-1 \).

If transform precoding is enabled according to 6.1 .3 of \( [6, \mathrm{TS} 38.214], v=1 \) and \( \tilde{x}^{(p)}(i) \) depends on the configuration of phase-tracking reference signals.

If the procedure in [6, TS 38.214] indicates that phase-tracking reference signals are not being used, the block of complex-valued symbols \( x^{(0)}(0), \ldots, x^{(0)}\left(M_{\text {symb }}^{\text {layer }}-1\right) \) for the single layer \( \lambda=0 \) shall be divided into \( M_{\text {symb }}^{\text {layer }} / M_{\mathrm{sc}}^{\mathrm{PUSCH}} \) sets, each corresponding to one OFDM symbol and \( \tilde{x}^{(p)}(i)=x^{(p)}(i) \).

If the procedure in [6, TS 38.214] indicates that phase-tracking reference signals are being used, the block of complexvalued symbols \( x^{(0)}(0), \ldots, x^{(0)}\left(M_{\text {symb }}^{\text {layer }}-1\right) \) shall be divided into sets, each set corresponding to one OFDM symbol, and where set \( l \) contains \( M_{\text {sc }}^{\text {PUSCH }}-\varepsilon_{1} N_{\text {samp }}^{\text {group }} N_{\text {group }}^{\text {PTRS }} \) symbols and is mapped to the complex-valued symbols
\( \tilde{x}^{(0)}\left(l M_{\mathrm{sc}}^{\mathrm{PUSCH}}+i^{\prime}\right) \) corresponding to OFDM symbol \( l \) prior to transform precoding, with \( i^{\prime} \in\left\{0,1, \ldots, M_{\mathrm{sc}}^{\mathrm{PUSCH}}-1\right\} \) and \( i^{\prime} \neq m \). The index \( m \) of PT-RS samples in set \( l \), the number of samples per PT-RS group \( N_{\text {samp }}^{\text {group }} \), and the number of PT-RS groups \( N_{\text {group }}^{\text {PT-RS }} \) are defined in clause 6.4.1.2.2.2. The quantity \( \varepsilon_{j}=1 \) when OFDM symbol \( l \) contains one or more PT-RS samples, otherwise \( \varepsilon_{j}=0 \).

Transform precoding shall be applied according to
\[
\begin{aligned}
y^{(\mathrm{v})}\left(l \cdot M_{\mathrm{sc}}^{\mathrm{PUSCH}}+k\right) & =\frac{1}{\sqrt{M_{\mathrm{sc}}^{\mathrm{PUSCH}}}} \sum_{i=0}^{M_{\mathrm{sc}}^{\text {PuscH }}-1} \tilde{x}^{(\mathrm{v})}\left(l \cdot M_{\mathrm{sc}}^{\mathrm{PUSCH}}+i\right) e^{-j \frac{2 \pi i k}{M_{\mathrm{sc}}^{\text {PLSCH }}}} \\
k & =0, \ldots, M_{\mathrm{sc}}^{\mathrm{PUSCH}}-1 \\
l & =0, \ldots, M_{\mathrm{symb}}^{\text {layer }} / M_{\mathrm{sc}}^{\mathrm{PUSCH}}-1
\end{aligned}
\]
resulting in a block of complex-valued symbols \( y^{(0)}(0), \ldots, y^{(0)}\left(M_{\text {symb }}^{\text {layer }}-1\right) \). The variable \( M_{\mathrm{sc}}^{\mathrm{PUSCH}}=M_{\mathrm{RB}}^{\mathrm{PUSCH}} \cdot N_{\mathrm{sc}}^{\mathrm{RB}} \), where \( M_{\text {RB }}^{\text {PUSCH }} \) represents the bandwidth of the PUSCH in terms of resource blocks, and shall fulfil
\[
M_{\mathrm{RB}}^{\mathrm{PUSCH}}=2^{\alpha_{2}} \cdot 3^{\alpha_{3}} \cdot 5^{\alpha_{5}}
\]
where \( \alpha_{2}, \alpha_{3}, \alpha_{5} \) is a set of non-negative integers.
6.3.1.5 Precoding

The block of vectors \( \left[y^{(0)}(i) \quad \ldots \quad y^{(v-1)}(i)\right]^{\mathrm{T}} \) shall be precoded according to
\[
\left[\begin{array}{c}
z^{\left(p_{0}\right)}(i) \\
\vdots \\
z^{\left(p_{\rho-1}\right)}(i)
\end{array}\right]=W\left[\begin{array}{c}
y^{(0)}(i) \\
\vdots \\
y^{(v-1)}(i)
\end{array}\right]
\]
where \( i=0,1, \ldots, M_{\text {symb }}^{\text {ap }}-1, M_{\text {symb }}^{\text {ap }}=M_{\text {symb }}^{\text {layer }} \). The set of antenna ports \( \left\{p_{0}, \ldots, p_{\rho-1}\right\} \) shall be determined according to the procedure in [6, TS 38.214].

For non-codebook-based transmission, the precoding matrix \( W \) equals the identity matrix.
For codebook-based transmission, the precoding matrix \( W \) depends on the number of antenna ports used for the transmission:
- for single-layer transmission on a single antenna port, \( W=1 \);

ETSI