<!-- Page 92 of ts_138213v170100p -->

3GPP TS 38.213 version 17.1.0 Release 17
91
ETSI TS 138213 V17.1.0 (2022-05)

the UE determines the \( \tilde{o}_{0}^{A C K}, \tilde{o}_{1}^{A C K}, \cdots, \tilde{o}_{O_{\mathrm{ACK}}-1}^{A C K} \) according to the previous pseudo-code with the following modifications
- \( \quad N_{\text {cells }}^{\mathrm{DL}} \) is used for the determination of a first HARQ-ACK sub-codebook for
- SPS PDSCH reception,
- any DCI format having associated HARQ-ACK information without scheduling PDSCH reception, and
- PDSCH reception scheduled by a DCI format scheduling one PDSCH
- PDSCH reception with \( N_{\text {HARQ-ACK }}^{\text {TBG, max }}=1 \) for TBG-based HARQ-ACK information on the \( N_{\text {cells }}^{\text {DLTB }} \) serving cells,
- \( \quad N_{\text {cells }}^{\text {DL }} \) is replaced by \( N_{\text {cells }}^{\text {DLTBG }} \) for the determination of a second HARQ-ACK sub-codebook corresponding to the \( N_{\text {cells }}^{\text {DLTBG }} \) serving cells for TBG-based HARQ-ACK information, or for TB-based HARQ-ACK information corresponding to multiple PDSCH receptions scheduled by a single DCI format, and
- if, for an active DL BWP of a serving cell, the UE is not provided coresetPoollndex or is provided coresetPoollndex with value 0 for one or more first CORESETs and is provided coresetPoollndex with value 1 for one or more second CORESETs, and is provided ackNackFeedbackMode = joint, the serving cell is counted as two times where the first time corresponds to the first CORESETs and the second time corresponds to the second CORESETs, and
- instead of generating one HARQ-ACK information bit per transport block for a serving cell from the \( N_{\text {cells }}^{\text {DLTBG }} \) serving cells, the UE generates \( N_{\text {HARQ-ACK, max }}^{\text {TBG, max }} \) HARQ-ACK information bits, where \( N_{\text {HARQ-ACK, max }}^{\text {TBG, is the }} \) maximum value between \( N_{\mathrm{TB}, c}^{\mathrm{DL}} \cdot N_{\mathrm{HARQ}-\mathrm{ACK}, c}^{\mathrm{TBG}} \) across all \( N_{\text {cells }}^{\mathrm{DL}, \mathrm{TBG}} \) serving cells if the UE is provided numberOfHARQ-BundlingGroups, and \( N_{\mathrm{TB}, c}^{\mathrm{DL}} \cdot N_{\mathrm{PDSCH}, c}^{\max } \) across all \( N_{\mathrm{cells}}^{\mathrm{DL}} \) serving cells where the UE is not provided numberOfHARQ-BundingGroups, and \( N_{\mathrm{TB}, c}^{\mathrm{DL}} \) is the value of maxNrofCodeWordsScheduledByDCI for serving cell \( c \) if harq-ACK-SpatialBundlingPUCCH is not provided; else, \( N_{\mathrm{TB}, c}^{\mathrm{DL}}=1 \). If for a serving cell \( c \) where the UE is provided numberOfHARQ-BundingGroups, it is \( N_{\mathrm{TB}, c}^{\mathrm{DL}} \cdot N_{\mathrm{HARQ}-\mathrm{ACK}, c}^{\mathrm{TBG}}<N_{\mathrm{HARQ}-\mathrm{ACK}, \max }^{\mathrm{TBG}} \), the UE generates NACK for the last \( N_{\text {HARQ-ACK },_{\text {max }}}^{\text {TBG }}-N_{\text {TB }, c}^{\text {DL }} \cdot N_{\text {HARQ-ACK }, c}^{\text {TBG },_{\text {max }}} \) HARQ-ACK information bits for serving cell \( c \). If for a serving cell \( c \) where the UE is not provided numberOfHARQ-BundlingGroups, it is \( N_{\mathrm{TB}, c}^{\mathrm{DL}} \cdot N_{\mathrm{PDSC}, c}^{\max }<N_{\mathrm{HARQ}-\mathrm{AC}, \max }^{\mathrm{TBG}, \max } \), the UE generates NACK for the last \( N_{\mathrm{HARQ}-\mathrm{ACK}, \max }^{\mathrm{TBG}}-N_{\mathrm{TB}, c}^{\mathrm{DL}} \cdot N_{\mathrm{PDSCH}, c}^{\max } \) HARQ-ACK information bits for serving cell \( c \).
- The pseudo-code operation when PDSCH-CodeBlockGroupTransmission is provided is not applicable.
- The counter DAI value and the total DAI value apply separately for each HARQ-ACK sub-codebook.
- The UE generates the HARQ-ACK codebook by appending the second HARQ-ACK sub-codebook to the first HARQ-ACK sub-codebook.

If \( O_{\mathrm{ACK}}+O_{\mathrm{SR}}+O_{\mathrm{CSI}} \leq 11 \) and \( N_{\text {cells }}^{\mathrm{DL}, \mathrm{TBG}}>0 \), the UE also determines \( n_{\text {HARQ-ACK }}=n_{\text {HARQ-ACK,TB }}+n_{\text {HARQ-ACK,TBG }} \) for obtaining a PUCCH transmission power, as described in clause 7.2.1, with
\[
n_{\mathrm{HARQ}-\mathrm{ACK}, \mathrm{TBG}}=\left(\left(V_{\mathrm{DA}, m_{\text {last }}}^{\mathrm{DL}}-\sum_{c=0}^{N_{\text {cells }}^{\mathrm{DL}, \mathrm{TBG}}}-1 U_{\mathrm{DAJ}, c}^{\mathrm{TBG}}\right) \bmod \left(T_{D}\right)\right) N_{\mathrm{HARQ}-\mathrm{ACK}, \max }^{\mathrm{TBG}, \max }+\sum_{c=0}^{N_{\text {cells }}^{\mathrm{DL}, \mathrm{TBG}}-1} \sum_{m=0}^{M-1} N_{m, c}^{\text {received,TBG }}
\]
where
- if \( N_{\text {cells }}^{\mathrm{DL}}=1, V_{\mathrm{DAI} m_{\text {last }}}^{\mathrm{DL}} \) is the value of the counter DAI in the last DCI format scheduling more than one PDSCH receptions for any serving cell \( c \) from the \( N_{\text {cells }}^{\text {DLTBG }} \) serving cells with TBG-based HARQ-ACK information or with TB-based HARQ-ACK information that the UE detects within the \( M \) PDCCH monitoring occasions
- if \( N_{\text {cells }}^{\mathrm{DL}}>1, V_{\mathrm{DAI}, m_{\text {last }}}^{\mathrm{DL}} \) is the value of the total DAI in the last DCI format scheduling more than one PDSCH receptions with TBG-based HARQ-ACK information or with TB-based HARQ-ACK information for any serving cell \( c \) from the \( N_{\text {cells }}^{\text {DLTBG }} \) serving cells that the UE detects within the \( M \) PDCCH monitoring occasions
- \( \quad V_{\mathrm{DAI}, m_{\text {last }}}^{\mathrm{DL}}=0 \), if the UE does not detect any DCI format scheduling more than one PDSCH receptions with TBG-based HARQ-ACK information or with TB-based HARQ-ACK information for any serving cell \( c \) from the \( N_{\text {cells }}^{\text {DLTBG }} \) serving cells in any of the \( M \) PDCCH monitoring occasions

ETSI